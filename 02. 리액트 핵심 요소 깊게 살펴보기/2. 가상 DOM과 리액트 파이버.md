# 가상 DOM과 리액트 파이버

### **가상 DOM의 탄생 배경**

브라우저가 웹페이지를 렌더링하는 과정 : HTML 파싱 → 스타일 → 레이아웃 → 페인팅 등
이 과정에서의 문제점

- 매우 복잡하고 많은 비용이 듦
- 렌더링 완료 이후에도 사용자의 인터랙션으로 웹페이지가 변경되는 상황도 고려해야 함
- 사용자의 인터랙션에 따라 DOM의 모든 변경 사항을 추적하는 것은 개발자 입장에서 너무 수고스러움

가상 DOM은 이러한 문제를 해결하기 위해 등장함

### 가상 DOM이란

가상 DOM은 웹페이지가 표시해야 할 DOM을 일단 메모리에 저장하고, 리액트가 실제 변경에 대한 준비가 완료됐을 때 실제 브라우저의 DOM에 반영함.

이를 통해

- 실제로는 여러 번 발생했을 렌더링 과정을 최소화할 수 있음
- 브라우저와 개발자의 부담을 덜 수 있음

그렇다고 해서 일반적인 DOM을 관리하는 브라우저보다 무조건 빠른 것은 아니고, 렌더링 최적화를 위한 하나의 방법일 뿐임

### **가상 DOM을 위한 아키텍처, 리액트 파이버**

**리액트 파이버(React Fiber)란**

가상 DOM과 렌더링 과정 최적화를 가능하게 해주는 것
리액트에서 어떤 부분을 새롭게 렌더링해야 하는지 가상 DOM과 실제 DOM을 비교하는 작업(알고리즘)

**리액트 파이버의 목표**

리액트 웹 애플리케이션에서 발생하는 애니메이션, 레이아웃, 그리고 사용자 인터랙션에 올바른 결과물을 만드는 반응성 문제를 해결하는 것
기존의 렌더링 스택의 비효율성을 타파하기 위해 스택 조정자 대신 파이버 개념이 탄생함

**파이버의 구현방식**

하나의 작업 단위를 처리하고 `finishedWork()`라는 작업으로 마무리한다. 이 작업을 커밋해 실제 브라우저 돔의 가시적인 변경 사항을 만들어 냄

- 렌더 단계에서는 리액트는 사용자에게 노출되지 않는 모든 비동기 작업을 수행함. 파이버의 작업, 우선순위를 지정하거나 중지시키거나 버리는 등의 작업이 일어남
- 커밋 단계에서는 돔의 실제 변경사항을 반영하기 위한 작업, `commitWork()`가 실행됨. 커밋 단계는 동기식으로 동작되며 중단도 하지 못함.

**리액트 파이버 트리**

리액트 내부에서 현재 모습을 담은 파이버 트리와 작업 중인 상태를 나타내는 workInProgress 트리가 존재함
리액트 파이버의 작업이 끝나면 리액트는 단순히 포인터만 변경해 workInProgress 트리를 현재 트리로 바꾸는 더블 버퍼링이 일어남

**파이버의 작업 순서**

일반적인 파이버 노드의 생성 흐름은 다음과 같음

1. 리액트는 beginWork() 힘수를 실행해 파이버 작업을 수행하는데, 더 이상 자식이 없는 파이버를 만날 때까지 트리 형식으로 시작된다.
2. 1에서 작업이 끝난다면 그다음 completeWork() 함수를 실행해 파이버 작업을 완료한다.
3. 형제가 있다면 형제로 넘어간다.
4. 2번, 3번이 모두 끝났다면 return으로 돌아가 자신의 작업이 완료됐음을 알린다.

**리액트의 작동 방식**

1. 초기 렌더링 후에 setState 등으로 업데이트가 발생하면, 리액트는 기존 current 트리를 유지하고 workInProgress 트리를 새로 빌드함
2. 이때 기존 파이버를 가급적 재사용하고, props만 업데이트하는 방식으로 새 트리를 만듦. 이는 리소스 낭비를 막기 위함임
3. 과거에는 트리 업데이트 작업이 동기적으로 진행되어 중단될 수 없었지만, 현재는 파이버 단위로 작업이 분리되어 우선순위에 따라 중단, 재개, 폐기가 가능함.
4. 리액트는 파이버 단위로 작업을 나누어 애니메이션, 사용자 입력 등 우선순위 높은 작업과 목록 렌더링 등 우선순위 낮은 작업을 분리하여 최적의 순서로 작업을 완료할 수 있게 함.
   요약하면 파이버 아키텍처를 통해 리액트는 기존 파이버 재사용, 작업 분할 및 우선순위 부여 등의 최적화를 수행하여 렌더링 프로세스를 개선했음

### 파이버와 가상 DOM

리액트 컴포넌트에 대한 정보를 1:1로 가지고 있는 것이 파이버임.
이 파이버는 리액트 아키텍처 내부에서 비동기로 이뤄짐.
실제 브라우저 구조인 DOM에 반영하는 것은 동기적으로 일어나야 함.

(Author: 초코)
